<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilPark - Y√∂netici Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #eef2f7; font-family: 'Segoe UI', sans-serif; }
        .header-box { background: linear-gradient(135deg, #1a2980, #26d0ce); color: white; padding: 1.5rem; border-radius: 0 0 20px 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .stat-card { background: white; border: none; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .plate-badge { background: #343a40; color: white; padding: 5px 10px; border-radius: 5px; font-family: monospace; font-weight: bold; border: 2px solid #000; }
        .filter-box { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .table thead th { border-top: none; color: #888; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; }
        .location-tag { font-size: 0.8rem; padding: 3px 8px; background: #e3f2fd; color: #1976d2; border-radius: 10px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="header-box d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0"><i class="fas fa-chart-line"></i> BilPark Komuta Merkezi</h2>
            <p class="mb-0 opacity-75">Canlƒ± Saha ƒ∞zleme ve Gelir Y√∂netimi</p>
        </div>
        <button onclick="handleReset()" class="btn btn-danger btn-sm shadow-sm">
            <i class="fas fa-exclamation-triangle"></i> Veritabanƒ±nƒ± Sƒ±fƒ±rla
        </button>
    </div>

    <div class="container-fluid px-4">
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card border-start border-5 border-success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Toplam Ciro</h6>
                            <h2 class="mb-0 fw-bold text-success"><span id="totalRevenue">0</span> ‚Ç∫</h2>
                        </div>
                        <i class="fas fa-wallet fa-2x text-success opacity-25"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card border-start border-5 border-primary">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Aktif Ara√ß Sayƒ±sƒ±</h6>
                            <h2 class="mb-0 fw-bold text-primary"><span id="activeCount">0</span></h2>
                        </div>
                        <i class="fas fa-car fa-2x text-primary opacity-25"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card border-start border-5 border-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">En Yoƒüun B√∂lge</h6>
                            <h4 class="mb-0 fw-bold text-dark"><span id="topZone">-</span></h4>
                        </div>
                        <i class="fas fa-map-marker-alt fa-2x text-warning opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            
            <div class="col-lg-8">
                <div class="filter-box d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-secondary"><i class="fas fa-video"></i> Canlƒ± Ara√ß Akƒ±≈üƒ±</h5>
                    
                    <div class="d-flex align-items-center">
                        <label class="me-2 text-muted small fw-bold">B√ñLGE Fƒ∞LTRESƒ∞:</label>
                        <select id="zoneFilter" class="form-select form-select-sm fw-bold text-primary" style="width: 200px;" onchange="loadData()">
                            <option value="T√ºm B√∂lgeler">üåê T√ºm B√∂lgeler</option>
                            <option value="Atat√ºrk Caddesi">Atat√ºrk Caddesi</option>
                            <option value="Cumhuriyet Meydanƒ±">Cumhuriyet Meydanƒ±</option>
                            <option value="Sahil Yolu">Sahil Yolu</option>
                            <option value="Sanayi Sitesi">Sanayi Sitesi</option>
                        </select>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Plaka</th>
                                        <th>Konum</th>
                                        <th>Giri≈ü Saati</th>
                                        <th>Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="vehicleList">
                                    <tr><td colspan="4" class="text-center py-5 text-muted">Veri bekleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                        <h5 class="text-secondary"><i class="fas fa-chart-pie"></i> B√∂lge Gelir Daƒüƒ±lƒ±mƒ±</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless">
                                <thead class="text-muted border-bottom">
                                    <tr>
                                        <th>B√∂lge Adƒ±</th>
                                        <th class="text-end">Kazan√ß</th>
                                    </tr>
                                </thead>
                                <tbody id="revenueTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000";
        
        // Sayfa a√ßƒ±lƒ±nca √ßalƒ±≈ütƒ±r
        window.onload = function() {
            loadData();
            // Her 3 saniyede bir verileri otomatik yenile (CANLI TAKƒ∞P Hƒ∞SSƒ∞)
            setInterval(loadData, 3000);
        };

        async function loadData() {
            await Promise.all([
                loadVehicles(),
                loadTotalRevenue(),
                loadZoneRevenue()
            ]);
        }

        // 1. ARA√áLARI Fƒ∞LTRELEYEREK GETƒ∞R
        async function loadVehicles() {
            const selectedZone = document.getElementById('zoneFilter').value;
            // API'ye filtreyi g√∂nderiyoruz (?location=...)
            const url = `${API_URL}/active-vehicles?location=${encodeURIComponent(selectedZone)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                const tbody = document.getElementById('vehicleList');
                document.getElementById('activeCount').innerText = data.length; // Sayacƒ± g√ºncelle

                if(data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted"><i class="fas fa-wind fa-2x mb-2"></i><br>Bu b√∂lgede aktif ara√ß yok.</td></tr>';
                    return;
                }

                tbody.innerHTML = "";
                data.forEach(v => {
                    const time = new Date(v.entry_time).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-4"><span class="plate-badge">${v.plate_number}</span></td>
                            <td><span class="location-tag">${v.location_name || 'Bilinmiyor'}</span></td>
                            <td><i class="far fa-clock text-muted"></i> ${time}</td>
                            <td><span class="badge bg-success bg-opacity-10 text-success">Aktif</span></td>
                        </tr>
                    `;
                });

            } catch (err) { console.error(err); }
        }

        // 2. TOPLAM GELƒ∞Rƒ∞ GETƒ∞R
        async function loadTotalRevenue() {
            try {
                const res = await fetch(`${API_URL}/total-revenue`);
                const data = await res.json();
                document.getElementById('totalRevenue').innerText = data.total_revenue;
            } catch (err) {}
        }

        // 3. B√ñLGESEL GELƒ∞R TABLOSU
        async function loadZoneRevenue() {
            try {
                const res = await fetch(`${API_URL}/revenue-by-location`);
                const data = await res.json();
                const tbody = document.getElementById('revenueTable');
                
                tbody.innerHTML = "";
                let topZoneName = "-";
                let maxRev = 0;

                data.forEach(item => {
                    const money = Number(item.total) || 0;
                    // En √ßok kazandƒ±ran b√∂lgeyi bul
                    if(money > maxRev) { maxRev = money; topZoneName = item.location_name; }

                    tbody.innerHTML += `
                        <tr>
                            <td class="py-2">${item.location_name}</td>
                            <td class="text-end fw-bold text-success py-2">${money} ‚Ç∫</td>
                        </tr>
                    `;
                });

                document.getElementById('topZone').innerText = topZoneName; // ƒ∞statistik kartƒ±na yaz

            } catch (err) {}
        }

        // 4. SIFIRLAMA (AYNI KALDI)
        async function handleReset() {
            if(confirm("‚ö†Ô∏è T√ºm veritabanƒ± silinecek! Onaylƒ±yor musun?")) {
                await fetch(`${API_URL}/reset`, { method: 'DELETE' });
                alert("Sistem temizlendi.");
                loadData();
            }
        }
    </script>
</body>
</html>